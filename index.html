<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PHONOBASE ¬∑ Avalia√ß√£o de Leitura Oral</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=IBM+Plex+Mono:wght@300;400;500;700&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050608;--s1:#090b10;--s2:#0e1118;--s3:#13171f;--s4:#1a1f2c;--s5:#222738;
  --glass:rgba(255,255,255,.04);--glass2:rgba(255,255,255,.07);--border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.04);
  --t0:#dce8ff;--t1:#8a9dc0;--t2:#4a566e;--t3:#252d3f;
  --cyan:#00d4ff;--cyanD:rgba(0,212,255,.1);--cyanD2:rgba(0,212,255,.06);--cyanG:rgba(0,212,255,.25);
  --grn:#00e5a0;--grnD:rgba(0,229,160,.1);
  --amb:#ffb340;--ambD:rgba(255,179,64,.1);
  --red:#ff4f6b;--redD:rgba(255,79,107,.1);
  --pur:#b06cff;--purD:rgba(176,108,255,.1);
  --rose:#ff6b9d;
  --lvl1:#00e5a0;--lvl2:#00d4ff;--lvl3:#ffb340;--lvl4:#ff4f6b;--lvl5:#b06cff;
}
html,body{height:100%;background:var(--bg);color:var(--t0);font-family:'Syne',sans-serif;font-size:13px;overflow:hidden}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--s5)}
::-webkit-scrollbar-track{background:transparent}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  background-size:256px;opacity:.4}

.app{display:grid;grid-template-rows:52px 1fr;height:100vh;position:relative;z-index:1}

/* TOP BAR */
.top{background:rgba(9,11,16,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:12px;z-index:100;position:relative}
.brand{font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:11px;letter-spacing:3px;
  color:var(--t0);padding-right:18px;margin-right:6px;border-right:1px solid var(--border);white-space:nowrap;
  display:flex;align-items:center;gap:8px}
.brand-icon{width:22px;height:22px;border-radius:50%;background:conic-gradient(var(--cyan),var(--pur),var(--rose),var(--cyan));
  display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.brand em{color:var(--cyan);font-style:normal}
.top-title{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--t2);text-transform:uppercase}
.top-r{display:flex;align-items:center;gap:8px;margin-left:auto}
.top-badge{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;
  padding:4px 10px;border:1px solid var(--border);color:var(--t2);text-transform:uppercase}
.top-badge.active{color:var(--grn);border-color:rgba(0,229,160,.3)}
.pulsedot{width:6px;height:6px;border-radius:50%;background:var(--grn);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}

/* LAYOUT */
.body{display:grid;grid-template-columns:260px 1fr;overflow:hidden}

/* SIDEBAR */
.sidebar{background:var(--s1);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}

/* PATIENT FORM */
.pat-form{padding:14px;border-bottom:1px solid var(--border2)}
.sec-label{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--t3);margin-bottom:8px}
.field{margin-bottom:8px}
.field label{font-size:10px;color:var(--t2);display:block;margin-bottom:3px;font-family:'IBM Plex Mono',monospace;letter-spacing:1px}
.field input,.field select{width:100%;background:var(--s2);border:1px solid var(--border);color:var(--t0);
  font-family:'IBM Plex Mono',monospace;font-size:10px;padding:6px 8px;outline:none;transition:border .15s}
.field input:focus,.field select:focus{border-color:var(--cyan)}
.field select option{background:var(--s2)}

/* LEVEL SELECTOR */
.levels-sec{padding:14px;border-bottom:1px solid var(--border2)}
.level-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.lvl-btn{padding:7px;background:var(--s2);border:1px solid var(--border);cursor:pointer;
  font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;
  color:var(--t2);transition:all .15s;text-align:center}
.lvl-btn:hover{border-color:var(--t2);color:var(--t1)}
.lvl-btn.active{color:var(--bg);font-weight:700}
.lvl-btn[data-lvl="1"].active{background:var(--lvl1);border-color:var(--lvl1)}
.lvl-btn[data-lvl="2"].active{background:var(--lvl2);border-color:var(--lvl2)}
.lvl-btn[data-lvl="3"].active{background:var(--lvl3);border-color:var(--lvl3)}
.lvl-btn[data-lvl="4"].active{background:var(--lvl4);border-color:var(--lvl4)}
.lvl-btn[data-lvl="5"].active{background:var(--lvl5);border-color:var(--lvl5)}
.lvl-btn[data-lvl="6"].active{background:linear-gradient(135deg,var(--red),var(--pur));border-color:var(--pur)}

.lvl-badge{display:inline-block;padding:2px 6px;font-size:8px;font-family:'IBM Plex Mono',monospace;margin-bottom:6px;border:1px solid;font-weight:700}
.lvl1{color:var(--lvl1);border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.05)}
.lvl2{color:var(--lvl2);border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.05)}
.lvl3{color:var(--lvl3);border-color:rgba(255,179,64,.3);background:rgba(255,179,64,.05)}
.lvl4{color:var(--lvl4);border-color:rgba(255,79,107,.3);background:rgba(255,79,107,.05)}
.lvl5{color:var(--lvl5);border-color:rgba(176,108,255,.3);background:rgba(176,108,255,.05)}
.lvl6{color:var(--rose);border-color:rgba(255,107,157,.3);background:rgba(255,107,157,.05)}

/* TEXT LIST */
.text-list{padding:14px;flex:1}
.text-item{padding:8px;background:var(--s2);border:1px solid var(--border);margin-bottom:4px;cursor:pointer;transition:all .12s}
.text-item:hover{border-color:var(--t2);background:var(--s3)}
.text-item.selected{border-left:2px solid var(--cyan);background:var(--cyanD2)}
.text-item-name{font-size:11px;color:var(--t1);margin-bottom:2px}
.text-item-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px}

/* MAIN AREA */
.main{display:flex;flex-direction:column;overflow:hidden}

/* HEADER WITH TIMER */
.reading-header{background:var(--s2);border-bottom:1px solid var(--border);padding:12px 20px;
  display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.timer-display{font-family:'IBM Plex Mono',monospace;font-size:28px;font-weight:700;letter-spacing:4px;
  color:var(--t0);min-width:90px}
.timer-display.running{color:var(--cyan);text-shadow:0 0 20px rgba(0,212,255,.4)}
.timer-display.stopped{color:var(--grn)}
.timer-btns{display:flex;gap:6px}
.tbtn{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
  padding:7px 14px;border:1px solid var(--border);background:none;color:var(--t2);cursor:pointer;transition:all .15s}
.tbtn:hover{border-color:var(--t1);color:var(--t1)}
.tbtn.start{border-color:rgba(0,229,160,.4);color:var(--grn)}
.tbtn.start:hover{background:var(--grnD)}
.tbtn.pause{border-color:rgba(255,179,64,.4);color:var(--amb)}
.tbtn.stop{border-color:rgba(255,79,107,.4);color:var(--red)}
.tbtn.report{border-color:rgba(176,108,255,.4);color:var(--pur)}
.tbtn.report:hover{background:var(--purD)}
.tbtn:disabled{opacity:.3;cursor:not-allowed}

.metrics-row{display:flex;gap:10px;align-items:center;margin-left:auto;flex-wrap:wrap}
.metric{text-align:center;padding:6px 12px;background:var(--s3);border:1px solid var(--border)}
.metric-val{font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:700;color:var(--t0)}
.metric-lbl{font-family:'IBM Plex Mono',monospace;font-size:7px;letter-spacing:2px;color:var(--t3);text-transform:uppercase;margin-top:1px}

/* PROGRESS BAR */
.progress-bar{height:3px;background:var(--s3);position:relative;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--pur));transition:width .5s;width:0%}

/* TEXT AREA */
.text-area{flex:1;overflow-y:auto;padding:32px 40px;display:flex;flex-direction:column;gap:16px}
.text-container{max-width:780px;margin:0 auto;width:100%}

.text-meta{margin-bottom:20px}
.text-title{font-family:'DM Serif Display',serif;font-size:24px;color:var(--t0);margin-bottom:6px;line-height:1.3}
.text-subtitle{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--t2);letter-spacing:2px}

.reading-text{font-size:17px;line-height:1.9;color:var(--t1);letter-spacing:.01em;font-weight:400;
  font-family:'DM Serif Display',serif;user-select:none}
.reading-text .word{cursor:pointer;transition:all .1s;border-radius:2px;padding:0 1px}
.reading-text .word:hover{color:var(--t0)}
.reading-text .word.error{background:rgba(255,79,107,.25);color:var(--red);text-decoration:line-through}
.reading-text .word.hesitation{background:rgba(255,179,64,.2);color:var(--amb)}
.reading-text .word.correct{color:var(--t0)}

.mark-controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border2)}
.mark-btn{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;
  padding:5px 10px;border:1px solid;background:none;cursor:pointer;transition:all .12s}
.mark-btn.err-btn{color:var(--red);border-color:rgba(255,79,107,.3)}
.mark-btn.err-btn:hover,.mark-btn.err-btn.active{background:rgba(255,79,107,.15)}
.mark-btn.hes-btn{color:var(--amb);border-color:rgba(255,179,64,.3)}
.mark-btn.hes-btn:hover,.mark-btn.hes-btn.active{background:rgba(255,179,64,.15)}
.mark-btn.clr-btn{color:var(--t2);border-color:var(--border)}
.mark-btn.clr-btn:hover{border-color:var(--t1);color:var(--t1)}
.mark-hint{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;align-self:center;margin-left:6px}

/* ANNOTATIONS */
.annotations{margin-top:16px;padding:12px;background:var(--s2);border:1px solid var(--border)}
.ann-label{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--t3);margin-bottom:6px}
.ann-textarea{width:100%;background:transparent;border:none;color:var(--t1);font-family:'Syne',sans-serif;font-size:12px;
  resize:none;outline:none;line-height:1.6;min-height:60px}

/* EMPTY STATE */
.empty-state{text-align:center;padding:60px 20px;color:var(--t2)}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:.3}
.empty-title{font-family:'DM Serif Display',serif;font-size:20px;color:var(--t1);margin-bottom:8px}
.empty-sub{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--t3);letter-spacing:1px}

/* MODAL - REPORT */
.modal-overlay{position:fixed;inset:0;background:rgba(5,6,8,.92);backdrop-filter:blur(10px);
  z-index:999;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border);max-width:760px;width:100%;max-height:90vh;
  overflow-y:auto;position:relative}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;letter-spacing:2px;color:var(--t0);text-transform:uppercase}
.modal-close{background:none;border:1px solid var(--border);color:var(--t2);width:28px;height:28px;cursor:pointer;
  font-size:14px;transition:all .15s}
.modal-close:hover{border-color:var(--red);color:var(--red)}

/* REPORT CONTENT */
.report-body{padding:24px}
.report-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border2)}
.report-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.report-sec-title{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;
  color:var(--cyan);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.report-sec-title::after{content:'';flex:1;height:1px;background:var(--border)}

.report-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.report-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.rstat{padding:12px;background:var(--s2);border:1px solid var(--border)}
.rstat-val{font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:700;color:var(--t0);line-height:1}
.rstat-unit{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--t2);margin-left:3px}
.rstat-lbl{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:1.5px;color:var(--t3);text-transform:uppercase;margin-top:4px}

.score-bar-wrap{margin:12px 0}
.score-bar-label{display:flex;justify-content:space-between;margin-bottom:4px}
.score-bar-name{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t1);letter-spacing:1px}
.score-bar-val{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--t0)}
.score-bar{height:4px;background:var(--s3);border-radius:0}
.score-bar-fill{height:100%;transition:width 1s ease;border-radius:0}

.report-text-block{background:var(--s2);border-left:3px solid var(--cyan);padding:12px 16px;margin:8px 0;
  font-size:12px;line-height:1.7;color:var(--t1)}
.report-text-block strong{color:var(--t0)}
.report-text-block.warn{border-left-color:var(--amb)}
.report-text-block.crit{border-left-color:var(--red)}
.report-text-block.good{border-left-color:var(--grn)}

.classification-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border:1px solid;font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase}

.print-btn{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
  padding:8px 16px;border:1px solid rgba(0,229,160,.3);background:none;color:var(--grn);cursor:pointer;transition:all .15s;margin-top:16px}
.print-btn:hover{background:var(--grnD)}

/* ERRORS LIST */
.error-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.error-tag{font-family:'IBM Plex Mono',monospace;font-size:9px;padding:2px 7px;background:rgba(255,79,107,.15);
  border:1px solid rgba(255,79,107,.3);color:var(--red)}
.hesitation-tag{font-family:'IBM Plex Mono',monospace;font-size:9px;padding:2px 7px;background:rgba(255,179,64,.15);
  border:1px solid rgba(255,179,64,.3);color:var(--amb)}

/* PHONOLOGICAL ANALYSIS */
.phono-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.phono-item{padding:8px 10px;background:var(--s2);border:1px solid var(--border)}
.phono-name{font-size:10px;color:var(--t1);margin-bottom:2px}
.phono-sub{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px}
.phono-val{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;float:right;margin-top:-16px}

/* LEVEL COLOR HELPERS */
.c1{color:var(--lvl1)}.c2{color:var(--lvl2)}.c3{color:var(--lvl3)}.c4{color:var(--lvl4)}.c5{color:var(--lvl5)}.c6{color:var(--rose)}
.b1{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.3)}
.b2{background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.3)}
.b3{background:rgba(255,179,64,.1);border-color:rgba(255,179,64,.3)}
.b4{background:rgba(255,79,107,.1);border-color:rgba(255,79,107,.3)}
.b5{background:rgba(176,108,255,.1);border-color:rgba(176,108,255,.3)}
.b6{background:rgba(255,107,157,.1);border-color:rgba(255,107,157,.3)}

/* Responsive tweaks */
@media(max-width:700px){
  .body{grid-template-columns:1fr}
  .sidebar{display:none}
}

/* PRINT STYLES */
@media print{
  .modal-overlay{position:relative;display:flex!important}
  .modal{max-height:none;border:none}
  .modal-close,.print-btn{display:none}
  body::before,.top,.app{display:block}
}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="brand-icon">üéô</div>
      PHONO<em>BASE</em>
    </div>
    <div class="top-title">Avalia√ß√£o de Leitura Oral ¬∑ Protocolo Fonoaudiol√≥gico</div>
    <div class="top-r">
      <div class="pulsedot"></div>
      <div class="top-badge active">Fono</div>
      <div class="top-badge" id="session-badge">Sess√£o ‚Äî</div>
    </div>
  </div>

  <div class="body">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <!-- PACIENTE -->
      <div class="pat-form">
        <div class="sec-label">Dados do Paciente</div>
        <div class="field">
          <label>Nome completo</label>
          <input type="text" id="pat-name" placeholder="Nome do paciente">
        </div>
        <div class="field">
          <label>Data de nascimento</label>
          <input type="date" id="pat-dob">
        </div>
        <div class="field">
          <label>Fonoaudi√≥logo(a)</label>
          <input type="text" id="pat-fono" placeholder="Nome do profissional">
        </div>
        <div class="field">
          <label>Diagn√≥stico / Hip√≥tese</label>
          <input type="text" id="pat-diag" placeholder="Ex: Dislexia, gagueira...">
        </div>
        <div class="field">
          <label>Escolaridade</label>
          <select id="pat-escola">
            <option value="">Selecionar</option>
            <option>Pr√©-escola</option>
            <option>1¬∫ ano EF</option>
            <option>2¬∫ ano EF</option>
            <option>3¬∫ ano EF</option>
            <option>4¬∫‚Äì5¬∫ ano EF</option>
            <option>6¬∫‚Äì9¬∫ ano EF</option>
            <option>Ensino M√©dio</option>
            <option>Ensino Superior</option>
            <option>Adulto (sem EF completo)</option>
          </select>
        </div>
      </div>

      <!-- N√çVEL -->
      <div class="levels-sec">
        <div class="sec-label">N√≠vel de dificuldade</div>
        <div class="level-grid">
          <button class="lvl-btn active" data-lvl="1" onclick="selectLevel(1,this)">üü¢ F√°cil</button>
          <button class="lvl-btn" data-lvl="2" onclick="selectLevel(2,this)">üîµ M√©dio</button>
          <button class="lvl-btn" data-lvl="3" onclick="selectLevel(3,this)">üü° Dif√≠cil</button>
          <button class="lvl-btn" data-lvl="4" onclick="selectLevel(4,this)">üî¥ Avan√ßado</button>
          <button class="lvl-btn" data-lvl="5" onclick="selectLevel(5,this)">üü£ Expert</button>
          <button class="lvl-btn" data-lvl="6" onclick="selectLevel(6,this)">üíÄ Extremo</button>
        </div>
      </div>

      <!-- TEXTOS -->
      <div class="text-list">
        <div class="sec-label">Textos dispon√≠veis</div>
        <div id="text-list-container"></div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- READING HEADER / TIMER -->
      <div class="reading-header">
        <div id="timer-display" class="timer-display">00:00</div>
        <div class="timer-btns">
          <button class="tbtn start" id="btn-start" onclick="startTimer()">‚ñ∂ Iniciar</button>
          <button class="tbtn pause" id="btn-pause" onclick="pauseTimer()" disabled>‚è∏ Pausar</button>
          <button class="tbtn stop" id="btn-stop" onclick="stopTimer()" disabled>‚èπ Parar</button>
          <button class="tbtn" id="btn-reset" onclick="resetTimer()">‚Ü∫ Reset</button>
        </div>
        <div class="metrics-row">
          <div class="metric">
            <div class="metric-val" id="m-wpm">‚Äî</div>
            <div class="metric-lbl">PPM</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="m-errors">0</div>
            <div class="metric-lbl">Erros</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="m-hesit">0</div>
            <div class="metric-lbl">Hesit.</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="m-accuracy">‚Äî</div>
            <div class="metric-lbl">Precis√£o</div>
          </div>
          <button class="tbtn report" id="btn-report" onclick="openReport()" disabled>üìä Relat√≥rio</button>
        </div>
      </div>

      <!-- PROGRESS -->
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

      <!-- MARK CONTROLS -->
      <div style="padding:8px 20px;background:var(--s2);border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase">Marcar:</span>
        <button class="mark-btn err-btn" id="mark-err-btn" onclick="setMarkMode('error')">‚úó Erro</button>
        <button class="mark-btn hes-btn" id="mark-hes-btn" onclick="setMarkMode('hesitation')">‚è§ Hesita√ß√£o</button>
        <button class="mark-btn clr-btn" onclick="setMarkMode('clear')">‚óã Limpar</button>
        <span class="mark-hint">Clique nas palavras para marcar</span>
        <button class="mark-btn clr-btn" style="margin-left:auto" onclick="clearAllMarks()">Limpar tudo</button>
      </div>

      <!-- TEXT AREA -->
      <div class="text-area" id="text-area">
        <div class="text-container">
          <div class="empty-state" id="empty-state">
            <div class="empty-icon">üìñ</div>
            <div class="empty-title">Selecione um texto</div>
            <div class="empty-sub">Escolha o n√≠vel e o texto na barra lateral</div>
          </div>
          <div id="text-content" style="display:none">
            <div class="text-meta">
              <div class="text-title" id="tc-title"></div>
              <div class="text-subtitle" id="tc-sub"></div>
            </div>
            <div class="reading-text" id="tc-words"></div>
            <div class="annotations">
              <div class="ann-label">Observa√ß√µes do fonoaudi√≥logo</div>
              <textarea class="ann-textarea" id="ann-notes" placeholder="Anota√ß√µes cl√≠nicas: qualidade de voz, postura, respira√ß√£o, pausas, pros√≥dia..." rows="3"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REPORT MODAL -->
<div class="modal-overlay" id="report-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üìä Relat√≥rio Fonoaudiol√≥gico ¬∑ Leitura Oral</div>
      <button class="modal-close" onclick="closeReport()">‚úï</button>
    </div>
    <div class="report-body" id="report-body"></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEXTS DATABASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TEXTS = {
1: [
  {
    id:'1a', name:'O Gato e o Sol', words: 80,
    title:'O Gato e o Sol',
    subtitle:'N√≠vel 1 ¬∑ Vocabul√°rio b√°sico ¬∑ S√≠labas simples',
    content:'O gato dorme ao sol. Ele √© preto e tem quatro patas. O gato gosta de leite e de peixe. Ele mia quando quer comer. De manh√£, o gato pula na cama e acorda a mam√£e. √Ä tarde, ele brinca com uma bola. √Ä noite, o gato dorme no sof√°. O gato √© um animal muito carinhoso. Ele gosta de colo e de carinhos. Toda a fam√≠lia ama o gato da casa.'
  },
  {
    id:'1b', name:'A Escola da Ana', words: 90,
    title:'A Escola da Ana',
    subtitle:'N√≠vel 1 ¬∑ Frases curtas ¬∑ Alta frequ√™ncia',
    content:'Ana vai para a escola todo dia. Ela acorda cedo e toma caf√©. A mochila dela √© azul. Na escola, Ana aprende a ler e a escrever. A professora dela se chama Maria. Ana gosta muito de pintar e de cantar. Na hora do recreio, ela brinca com os amigos. Eles jogam bola e pulam corda. √Ä tarde, Ana volta para casa. Ela faz o dever de casa e depois assiste televis√£o. Ana adora a escola.'
  }
],
2: [
  {
    id:'2a', name:'A Amaz√¥nia', words: 110,
    title:'A Floresta Amaz√¥nica',
    subtitle:'N√≠vel 2 ¬∑ Vocabul√°rio intermedi√°rio ¬∑ Frases compostas',
    content:'A floresta amaz√¥nica √© a maior floresta tropical do mundo. Ela cobre grande parte do Brasil e de outros pa√≠ses da Am√©rica do Sul. Na Amaz√¥nia, vivem milhares de esp√©cies de animais e plantas. O rio Amazonas atravessa a floresta e des√°gua no oceano Atl√¢ntico. Muitas comunidades ind√≠genas vivem na floresta e conhecem seus segredos. A Amaz√¥nia produz oxig√™nio para todo o planeta e regula o clima global. Por isso, √© muito importante preservar essa floresta t√£o especial. O desmatamento √© uma amea√ßa grave que precisa ser combatida por todos.'
  },
  {
    id:'2b', name:'Os Planetas', words: 105,
    title:'O Sistema Solar',
    subtitle:'N√≠vel 2 ¬∑ Ci√™ncias ¬∑ Vocabul√°rio espec√≠fico',
    content:'O sistema solar √© formado pelo Sol e por oito planetas. Os planetas giram ao redor do Sol em √≥rbitas diferentes. Merc√∫rio √© o planeta mais pr√≥ximo do Sol e o mais quente. V√™nus tem uma atmosfera densa e temperaturas alt√≠ssimas. A Terra √© o √∫nico planeta onde existe vida conhecida. Marte √© vermelho por causa do √≥xido de ferro em sua superf√≠cie. J√∫piter √© o maior planeta e tem uma grande tempestade chamada Mancha Vermelha. Saturno tem an√©is formados de gelo e rocha. Urano e Netuno s√£o os planetas mais distantes e mais frios.'
  }
],
3: [
  {
    id:'3a', name:'Revolu√ß√£o Industrial', words: 130,
    title:'A Revolu√ß√£o Industrial',
    subtitle:'N√≠vel 3 ¬∑ Texto hist√≥rico ¬∑ Vocabul√°rio t√©cnico',
    content:'A Revolu√ß√£o Industrial transformou profundamente a sociedade europeia a partir do s√©culo XVIII. Iniciada na Inglaterra, essa transforma√ß√£o marcou a transi√ß√£o da produ√ß√£o artesanal para a produ√ß√£o mecanizada. A inven√ß√£o da m√°quina a vapor por James Watt foi fundamental para esse processo, permitindo a cria√ß√£o de locomotivas, navios e f√°bricas. Trabalhadores abandonaram o campo e migraram para as cidades em busca de emprego nas ind√∫strias. As condi√ß√µes de trabalho eram prec√°rias: jornadas de doze a dezesseis horas, sal√°rios baixos e aus√™ncia de direitos trabalhistas. Esse contexto gerou os primeiros movimentos oper√°rios e sindicatos, que lutaram por melhores condi√ß√µes. A Revolu√ß√£o Industrial tamb√©m intensificou o colonialismo, pois as pot√™ncias europeias precisavam de mat√©ria-prima e mercados consumidores.'
  },
  {
    id:'3b', name:'Neuroci√™ncia e Mem√≥ria', words: 125,
    title:'Como o C√©rebro Forma Mem√≥rias',
    subtitle:'N√≠vel 3 ¬∑ Ci√™ncias da sa√∫de ¬∑ Termos t√©cnicos',
    content:'A forma√ß√£o de mem√≥rias √© um processo complexo que envolve diversas estruturas cerebrais. O hipocampo desempenha papel central na consolida√ß√£o da mem√≥ria epis√≥dica, aquela relacionada a eventos e experi√™ncias pessoais. Durante o sono, o c√©rebro reprocessa as informa√ß√µes adquiridas durante o dia, transferindo-as da mem√≥ria de curto prazo para a de longo prazo. A plasticidade sin√°ptica, especialmente o fen√¥meno conhecido como potencia√ß√£o de longa dura√ß√£o, √© o mecanismo celular subjacente ao aprendizado. Neurotransmissores como glutamato e dopamina modulam a intensidade com que as mem√≥rias s√£o gravadas. Situa√ß√µes emocionalmente intensas produzem mem√≥rias mais v√≠vidas porque a am√≠gdala, estrutura relacionada √†s emo√ß√µes, potencializa a atividade do hipocampo durante a codifica√ß√£o.'
  }
],
4: [
  {
    id:'4a', name:'Disfagia Orofar√≠ngea', words: 145,
    title:'Fisiopatologia da Disfagia Orofar√≠ngea',
    subtitle:'N√≠vel 4 ¬∑ Texto cient√≠fico ¬∑ Terminologia fonoaudiol√≥gica',
    content:'A disfagia orofar√≠ngea caracteriza-se por dificuldade na degluti√ß√£o decorrente de altera√ß√µes nas fases oral, far√≠ngea ou na transi√ß√£o faringoesof√°gica. As causas mais frequentes incluem acidente vascular encef√°lico, doen√ßa de Parkinson, esclerose lateral amiotr√≥fica e neoplasias de cabe√ßa e pesco√ßo. Do ponto de vista neurofisiol√≥gico, a degluti√ß√£o normal exige a coordena√ß√£o precisa de mais de trinta m√∫sculos, regulados pelo tronco encef√°lico e por estruturas supratentoriais. A penetra√ß√£o lar√≠ngea e a aspira√ß√£o traqueobr√¥nquica representam as complica√ß√µes mais graves, podendo resultar em pneumonia aspirativa com significativa morbimortalidade. A avalia√ß√£o cl√≠nica fonoaudiol√≥gica, complementada pela videofluoroscopia da degluti√ß√£o e pela videoendoscopia da degluti√ß√£o com fibra √≥ptica, constitui o padr√£o ouro diagn√≥stico. O manejo terap√™utico inclui estrat√©gias posturais, manobras de degluti√ß√£o e modifica√ß√£o de consist√™ncias alimentares conforme a International Dysphagia Diet Standardisation Initiative.'
  },
  {
    id:'4b', name:'An√°lise Ac√∫stica da Voz', words: 140,
    title:'Par√¢metros Ac√∫sticos na Avalia√ß√£o Vocal',
    subtitle:'N√≠vel 4 ¬∑ Fonoaudiologia cl√≠nica ¬∑ Terminologia especializada',
    content:'A avalia√ß√£o ac√∫stica da voz constitui instrumento fundamental na pr√°tica fonoaudiol√≥gica contempor√¢nea. Par√¢metros como frequ√™ncia fundamental, jitter, shimmer e propor√ß√£o harm√¥nico-ru√≠do permitem quantificar objetivamente as caracter√≠sticas vibrat√≥rias das pregas vocais. A frequ√™ncia fundamental m√©dia varia entre cento e vinte e duzentos e cinquenta hertz em homens adultos e entre cento e noventa e duzentos e noventa hertz em mulheres. Perturba√ß√µes de frequ√™ncia, mensuradas pelo jitter, acima de um por cento indicam irregularidade vibrat√≥ria significativa. O shimmer, perturba√ß√£o de amplitude, quando superior a tr√™s decib√©is, sugere altera√ß√£o na coapta√ß√£o gl√≥tica. A propor√ß√£o harm√¥nico-ru√≠do abaixo de quinze decib√©is indica excesso de ru√≠do no sinal vocal. Tais medidas, obtidas por softwares especializados como o Praat e o Multi-Dimensional Voice Program, devem ser interpretadas sempre em conjunto com a avalia√ß√£o perceptivo-auditiva e laringosc√≥pica, evitando conclus√µes reducionistas baseadas exclusivamente em dados ac√∫sticos isolados.'
  }
],
5: [
  {
    id:'5a', name:'Epigen√©tica e Linguagem', words: 165,
    title:'Epigen√©tica, Plasticidade Cerebral e Aquisi√ß√£o de Linguagem',
    subtitle:'N√≠vel 5 ¬∑ Alta complexidade ¬∑ Artigo cient√≠fico',
    content:'A intersec√ß√£o entre epigen√©tica e neuroci√™ncia da linguagem tem revelado mecanismos surpreendentes pelos quais a experi√™ncia ambiental modula a express√£o g√™nica em circuitos neuronais subjacentes √† comunica√ß√£o humana. Processos epigen√©ticos como metila√ß√£o do DNA, modifica√ß√µes de histonas e regula√ß√£o por RNA n√£o codificante modulam a transcri√ß√£o de genes relacionados √† sinaptog√™nese e √† mieliniza√ß√£o em regi√µes como o giro frontal inferior, o plano temporal e o fasc√≠culo arqueado. Estudos longitudinais demonstram que a riqueza do input lingu√≠stico nos primeiros trinta e seis meses de vida produz modifica√ß√µes epigen√©ticas duradouras que influenciam trajet√≥rias de desenvolvimento fonol√≥gico, morfossint√°tico e lexical. O fen√¥meno conhecido como per√≠odo cr√≠tico, durante o qual a plasticidade sin√°ptica est√° maximizada, √© parcialmente regulado pela express√£o de fatores de transcri√ß√£o como o FOXP2, cujas variantes t√™m sido associadas a transtornos espec√≠ficos da linguagem. As implica√ß√µes cl√≠nicas desse campo emergente para a interven√ß√£o fonoaudiol√≥gica precoce s√£o profundas: sugerem que o timing e a qualidade da estimula√ß√£o comunicativa na primeira inf√¢ncia transcendem o n√≠vel comportamental, operando em substratos moleculares com efeitos potencialmente transgeracionais.'
  },
  {
    id:'5b', name:'Gagueira Neurog√™nica', words: 160,
    title:'Neurobiologia da Gagueira: Da Disfun√ß√£o √† Interven√ß√£o Baseada em Evid√™ncia',
    subtitle:'N√≠vel 5 ¬∑ Fonoaudiologia avan√ßada ¬∑ Literatura especializada',
    content:'A gagueira desenvolvimental persistente tem substrato neurobiol√≥gico bem estabelecido, evidenciado por d√©cadas de estudos de neuroimagem funcional e estrutural. Metan√°lises de exames por resson√¢ncia magn√©tica funcional demonstram consistentemente hipoativa√ß√£o do giro frontal inferior esquerdo, especialmente a √°rea de Broca, e hiperativa√ß√£o hom√≥loga direita durante a fala, sugerindo atipicidade na lateraliza√ß√£o hemisf√©rica do processamento motor da fala. Anormalidades na subst√¢ncia branca do fasc√≠culo arqueado, do fasc√≠culo frontal orbital e das vias corticoespinhais foram identificadas por estudos de tensor de difus√£o, indicando comprometimento na transmiss√£o de sinal entre regi√µes de planejamento e execu√ß√£o motora. A dopamina desempenha papel modulat√≥rio relevante, explicando a efic√°cia parcial de agentes antidopamin√©rgicos em subgrupos espec√≠ficos. A abordagem terap√™utica contempor√¢nea, fundamentada nas terapias de regula√ß√£o da flu√™ncia e nas abordagens de aceita√ß√£o e comprometimento, reconhece que os desfechos em qualidade de vida e participa√ß√£o comunicativa s√£o clinicamente superiores ao crit√©rio exclusivo de supress√£o de disflu√™ncias, demandando do fonoaudi√≥logo compet√™ncias que integrem a neurocogni√ß√£o do controle motor da fala com a psicologia do autoconceito e da identidade do falante.'
  }
],
6: [
  {
    id:'6a', name:'Trocas Fonol√≥gicas Extremas', words: 140,
    title:'Processamento Fonol√≥gico em Transtornos Complexos da Comunica√ß√£o',
    subtitle:'N√≠vel 6 ¬∑ EXTREMO ¬∑ Fonologia ¬∑ Trava-l√≠nguas cl√≠nicos ¬∑ M√°xima dificuldade articulat√≥ria',
    content:'O fonoaudi√≥logo, avaliando a fonoarticula√ß√£o do paciente, perguntou: "Pode pronunciar pseudopalavras polisil√°bicas? Tente: frangip√¢nzila, xifop√°gio, estrelitzia, psicotronismo, zaraguat√£o, esternocleidomastoideo, feocromocitoma, hepatoesplenomegalia." O processamento fonol√≥gico suprassegmental pressup√µe representa√ß√µes lexicais especificadas com tra√ßos distintivos de sonoridade, vozeamento, ponto e modo de articula√ß√£o. Fricativas sibilantes interdentais, africadas palatoalveolares, consoantes nasais velares: cada fonema demanda coordena√ß√£o neuromuscular precisa entre laringe, v√©u palatino, l√≠ngua e l√°bios. Transtornos fonol√≥gicos inconsistentes caracterizam-se por variabilidade imprevis√≠vel nos padr√µes de erro, distinguindo-se da dispraxia verbal desenvolvimental pela preserva√ß√£o relativa da praxis n√£o-verbal. A estimulabilidade para sons-alvo ausentes do invent√°rio fonol√≥gico prediz progn√≥stico terap√™utico. Avalie: "O peito-azul-grande piou para o pica-pau-an√£o que protegia seus pintinhos no p√© do ip√™-de-jardim." Respire, controle o fluxo expirat√≥rio, coordene a fona√ß√£o com a articula√ß√£o.'
  },
  {
    id:'6b', name:'Texto Extremo Multissist√™mico', words: 155,
    title:'Avalia√ß√£o Multidimensional dos Subsistemas da Fala',
    subtitle:'N√≠vel 6 ¬∑ EXTREMO ¬∑ Pros√≥dia ¬∑ Articula√ß√£o ¬∑ Flu√™ncia ¬∑ Voz ¬∑ Cogni√ß√£o',
    content:'Subsistemas da fala ‚Äî respira√ß√£o, fona√ß√£o, resson√¢ncia, articula√ß√£o, pros√≥dia ‚Äî operam em sinergia neuromuscular que pressup√µe integridade dos nervos cranianos V, VII, IX, X, XI e XII, do nervo fr√™nico e dos intercostais. Leia em voz alta, mantendo qualidade vocal, taxa de fala adequada e pros√≥dia expressiva: "Pseudopseudohipoparatiroidismo, esternocleidomastoideo, hepatoesplenomegalia, feocromocitoma, pneumonoultramicroscopicosilicovolcanoconiose." Agora com √™nfase expressiva: "O xenof√≥bico xerife extraordinariamente exc√™ntrico exigiu que expulsassem extemporaneamente os exploradores estrangeiros." Com ritmo regular: "Tr√™s pratos de trigo para tr√™s tigres tristes." Mais complexo: "O rato roeu a roupa do rei de Roma; a rainha com raiva rasgou o resto." Avalie sua pr√≥pria pros√≥dia: variou o tom? Manteve a velocidade? Controlou pausas? A leitura oral de textos tecnicamente densos exige integra√ß√£o entre processamento fonol√≥gico, morfossint√°tico, sem√¢ntico e pragm√°tico, al√©m de suporte respirat√≥rio adequado, controle lar√≠ngeo e coordena√ß√£o velofar√≠ngea ‚Äî todo o sistema de fala em opera√ß√£o simult√¢nea.'
  }
]
};

const LEVEL_NAMES = {1:'F√°cil',2:'M√©dio',3:'Dif√≠cil',4:'Avan√ßado',5:'Expert',6:'Extremo'};
const LEVEL_COLORS = {1:'c1',2:'c2',3:'c3',4:'c4',5:'c5',6:'c6'};
const LEVEL_BADGES = {1:'lvl1',2:'lvl2',3:'lvl3',4:'lvl4',5:'lvl5',6:'lvl6'};

/* ‚ïê‚ïê STATE ‚ïê‚ïê */
let currentLevel = 1;
let currentText = null;
let timerInterval = null;
let elapsedSeconds = 0;
let timerRunning = false;
let timerStarted = false;
let markMode = 'error';
let wordElements = [];
let errors = new Set();
let hesitations = new Set();
let sessionId = 'SES-' + Date.now().toString(36).toUpperCase();

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
document.getElementById('session-badge').textContent = sessionId.slice(0,12);
selectLevel(1, document.querySelector('.lvl-btn[data-lvl="1"]'));

/* ‚ïê‚ïê LEVEL SELECT ‚ïê‚ïê */
function selectLevel(lvl, btn) {
  currentLevel = lvl;
  document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTextList();
  selectText(null);
}

function renderTextList() {
  const container = document.getElementById('text-list-container');
  const texts = TEXTS[currentLevel] || [];
  container.innerHTML = texts.map(t => `
    <div class="text-item" id="ti-${t.id}" onclick="selectText('${t.id}')">
      <div class="text-item-name">${t.name}</div>
      <div class="text-item-meta">${t.words} palavras ¬∑ N√≠vel ${currentLevel}</div>
    </div>
  `).join('');
}

/* ‚ïê‚ïê TEXT SELECT ‚ïê‚ïê */
function selectText(id) {
  if (!id) {
    currentText = null;
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('text-content').style.display = 'none';
    return;
  }
  
  resetTimer();
  errors.clear();
  hesitations.clear();
  updateMetrics();

  const texts = TEXTS[currentLevel];
  currentText = texts.find(t => t.id === id);
  
  document.querySelectorAll('.text-item').forEach(el => el.classList.remove('selected'));
  const el = document.getElementById('ti-' + id);
  if (el) el.classList.add('selected');

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('text-content').style.display = 'block';
  document.getElementById('tc-title').textContent = currentText.title;
  document.getElementById('tc-sub').textContent = currentText.subtitle;
  document.getElementById('ann-notes').value = '';

  renderWords();
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-report').disabled = true;
}

function renderWords() {
  const container = document.getElementById('tc-words');
  const words = currentText.content.split(/\s+/);
  wordElements = [];
  container.innerHTML = words.map((w, i) => `<span class="word" id="w${i}" onclick="markWord(${i})">${w}</span> `).join('');
  wordElements = words.map((w, i) => ({word: w.replace(/[^a-z√°√©√≠√≥√∫√¢√™√Æ√¥√ª√£√µ√ß√†√º\w]/gi,''), raw: w, idx: i}));
  updateProgress();
}

/* ‚ïê‚ïê MARK MODE ‚ïê‚ïê */
function setMarkMode(mode) {
  markMode = mode;
  document.querySelectorAll('.mark-btn').forEach(b => b.classList.remove('active'));
  if (mode === 'error') document.getElementById('mark-err-btn').classList.add('active');
  if (mode === 'hesitation') document.getElementById('mark-hes-btn').classList.add('active');
}

function markWord(idx) {
  const el = document.getElementById('w' + idx);
  if (!el) return;
  if (markMode === 'clear') {
    errors.delete(idx);
    hesitations.delete(idx);
    el.className = 'word';
  } else if (markMode === 'error') {
    if (errors.has(idx)) { errors.delete(idx); el.className = 'word'; }
    else { errors.add(idx); hesitations.delete(idx); el.className = 'word error'; }
  } else if (markMode === 'hesitation') {
    if (hesitations.has(idx)) { hesitations.delete(idx); el.className = 'word'; }
    else { hesitations.add(idx); errors.delete(idx); el.className = 'word hesitation'; }
  }
  updateMetrics();
}

function clearAllMarks() {
  errors.clear();
  hesitations.clear();
  document.querySelectorAll('.word').forEach(el => el.className = 'word');
  updateMetrics();
}

/* ‚ïê‚ïê TIMER ‚ïê‚ïê */
function startTimer() {
  if (!currentText) return;
  timerRunning = true;
  timerStarted = true;
  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-pause').disabled = false;
  document.getElementById('btn-stop').disabled = false;
  document.getElementById('timer-display').className = 'timer-display running';
  timerInterval = setInterval(() => {
    elapsedSeconds++;
    updateTimerDisplay();
    updateMetrics();
  }, 1000);
}

function pauseTimer() {
  if (!timerRunning) return;
  clearInterval(timerInterval);
  timerRunning = false;
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('timer-display').className = 'timer-display';
}

function stopTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('btn-stop').disabled = true;
  document.getElementById('timer-display').className = 'timer-display stopped';
  if (timerStarted) document.getElementById('btn-report').disabled = false;
  updateMetrics();
}

function resetTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  timerStarted = false;
  elapsedSeconds = 0;
  updateTimerDisplay();
  document.getElementById('timer-display').className = 'timer-display';
  document.getElementById('btn-start').disabled = !currentText;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('btn-stop').disabled = true;
  document.getElementById('btn-report').disabled = true;
  document.getElementById('m-wpm').textContent = '‚Äî';
  document.getElementById('m-accuracy').textContent = '‚Äî';
  document.getElementById('progress-fill').style.width = '0%';
}

function updateTimerDisplay() {
  const m = Math.floor(elapsedSeconds / 60);
  const s = elapsedSeconds % 60;
  document.getElementById('timer-display').textContent = 
    String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

function updateMetrics() {
  const errCount = errors.size;
  const hesCount = hesitations.size;
  document.getElementById('m-errors').textContent = errCount;
  document.getElementById('m-hesit').textContent = hesCount;

  if (elapsedSeconds > 0 && currentText) {
    const totalWords = wordElements.length;
    const correctWords = totalWords - errCount;
    const wpm = Math.round((totalWords / elapsedSeconds) * 60);
    const accuracy = Math.round((correctWords / totalWords) * 100);
    document.getElementById('m-wpm').textContent = wpm;
    document.getElementById('m-accuracy').textContent = accuracy + '%';
    updateProgress();
  }
}

function updateProgress() {
  if (!currentText) return;
  const total = wordElements.length;
  const marked = errors.size + hesitations.size;
  const pct = timerStarted ? Math.min(100, Math.round((elapsedSeconds / Math.max(60, elapsedSeconds)) * 100)) : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
}

/* ‚ïê‚ïê REPORT ‚ïê‚ïê */
function openReport() {
  if (!currentText) return;
  buildReport();
  document.getElementById('report-modal').classList.add('open');
}

function closeReport() {
  document.getElementById('report-modal').classList.remove('open');
}

function buildReport() {
  const totalWords = wordElements.length;
  const errCount = errors.size;
  const hesCount = hesitations.size;
  const correctWords = totalWords - errCount;
  const wpm = elapsedSeconds > 0 ? Math.round((totalWords / elapsedSeconds) * 60) : 0;
  const accuracy = Math.round((correctWords / totalWords) * 100);
  const hesRate = Math.round((hesCount / totalWords) * 100);
  const errRate = Math.round((errCount / totalWords) * 100);
  const minutes = Math.floor(elapsedSeconds / 60);
  const seconds = elapsedSeconds % 60;
  const timeStr = String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0');

  const patName = document.getElementById('pat-name').value || '‚Äî';
  const patFono = document.getElementById('pat-fono').value || '‚Äî';
  const patDiag = document.getElementById('pat-diag').value || '‚Äî';
  const patEscola = document.getElementById('pat-escola').value || '‚Äî';
  const patDob = document.getElementById('pat-dob').value;
  const notes = document.getElementById('ann-notes').value;

  const today = new Date().toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric'});
  const hour = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});

  // AGE CALCULATION
  let ageStr = '‚Äî';
  if (patDob) {
    const dob = new Date(patDob);
    const age = Math.floor((new Date() - dob) / 31557600000);
    ageStr = age + ' anos';
  }

  // CLASSIFICATION
  const lvlName = LEVEL_NAMES[currentLevel];
  let classification = '', classColor = '', classDesc = '';
  if (accuracy >= 97 && hesRate <= 2) {
    classification = 'N√≠vel Independente'; classColor = 'grn';
    classDesc = 'O paciente l√™ sem aux√≠lio externo neste n√≠vel. Taxa de precis√£o excelente.';
  } else if (accuracy >= 90 && hesRate <= 10) {
    classification = 'N√≠vel Instrucional'; classColor = 'cyan';
    classDesc = 'N√≠vel adequado para instru√ß√£o com suporte do fonoaudi√≥logo. Progress√£o indicada.';
  } else if (accuracy >= 80) {
    classification = 'N√≠vel Frustracional'; classColor = 'amb';
    classDesc = 'Dificuldade significativa neste n√≠vel. Recomenda-se revis√£o do n√≠vel de dificuldade ou maior suporte terap√™utico.';
  } else {
    classification = 'N√≠vel Cr√≠tico'; classColor = 'red';
    classDesc = 'O paciente apresenta dificuldade severa. Investiga√ß√£o aprofundada indicada.';
  }

  // WPM BENCHMARK (by age/level)
  let wpmBenchmark = {low:0, avg:0, high:0, label:''};
  if (currentLevel <= 2) wpmBenchmark = {low:60,avg:90,high:120,label:'Leitura b√°sica'};
  else if (currentLevel === 3) wpmBenchmark = {low:100,avg:130,high:160,label:'Leitura intermedi√°ria'};
  else if (currentLevel === 4) wpmBenchmark = {low:120,avg:150,high:180,label:'Leitura avan√ßada'};
  else wpmBenchmark = {low:130,avg:165,high:200,label:'Leitura especializada'};

  let wpmClass = wpm >= wpmBenchmark.high ? 'good' : wpm >= wpmBenchmark.avg ? '' : wpm >= wpmBenchmark.low ? 'warn' : 'crit';

  // ERROR WORDS
  const errorWords = [...errors].map(i => wordElements[i]?.raw || '').filter(Boolean);
  const hesWords = [...hesitations].map(i => wordElements[i]?.raw || '').filter(Boolean);

  // PHONOLOGICAL ERROR ANALYSIS
  const phonoPatterns = analyzePhonologicalPatterns(errorWords, hesWords);

  // CLINICAL IMPRESSIONS
  const impressions = generateClinicalImpressions(wpm, wpmBenchmark, accuracy, hesRate, errRate, currentLevel);

  // BUILD HTML
  const html = `
  <div class="report-section">
    <div class="report-sec-title">Identifica√ß√£o</div>
    <div class="report-grid">
      <div class="rstat"><div class="rstat-val">${patName}</div><div class="rstat-lbl">Paciente</div></div>
      <div class="rstat"><div class="rstat-val">${ageStr}</div><div class="rstat-lbl">Idade</div></div>
      <div class="rstat"><div class="rstat-val">${today} ${hour}</div><div class="rstat-lbl">Data/Hora</div></div>
    </div>
    <div class="report-grid">
      <div class="rstat"><div class="rstat-val">${patFono}</div><div class="rstat-lbl">Fonoaudi√≥logo(a)</div></div>
      <div class="rstat"><div class="rstat-val">${patEscola}</div><div class="rstat-lbl">Escolaridade</div></div>
      <div class="rstat"><div class="rstat-val">${patDiag}</div><div class="rstat-lbl">Diagn√≥stico / Hip√≥tese</div></div>
    </div>
  </div>

  <div class="report-section">
    <div class="report-sec-title">Classifica√ß√£o Geral</div>
    <div class="classification-badge b${currentLevel} c${currentLevel}" style="margin-bottom:12px">
      <span>‚óè</span> ${classification} ¬∑ N√≠vel ${lvlName}
    </div>
    <div class="report-text-block ${wpmClass.includes('good') ? 'good' : wpmClass === 'warn' ? 'warn' : wpmClass === 'crit' ? 'crit' : ''}">
      ${classDesc}
    </div>
  </div>

  <div class="report-section">
    <div class="report-sec-title">Indicadores Quantitativos</div>
    <div class="report-grid">
      <div class="rstat"><div class="rstat-val">${wpm}<span class="rstat-unit">PPM</span></div><div class="rstat-lbl">Palavras por minuto</div></div>
      <div class="rstat"><div class="rstat-val">${accuracy}<span class="rstat-unit">%</span></div><div class="rstat-lbl">Precis√£o leitora</div></div>
      <div class="rstat"><div class="rstat-val">${timeStr}</div><div class="rstat-lbl">Tempo total</div></div>
    </div>
    <div class="report-grid">
      <div class="rstat"><div class="rstat-val">${errCount}</div><div class="rstat-lbl">Erros de leitura</div></div>
      <div class="rstat"><div class="rstat-val">${hesCount}</div><div class="rstat-lbl">Hesita√ß√µes</div></div>
      <div class="rstat"><div class="rstat-val">${totalWords}</div><div class="rstat-lbl">Total de palavras</div></div>
    </div>

    <div style="margin-top:14px">
      ${buildScoreBar('Precis√£o', accuracy, 100, accuracy >= 97 ? '#00e5a0' : accuracy >= 90 ? '#00d4ff' : accuracy >= 80 ? '#ffb340' : '#ff4f6b')}
      ${buildScoreBar('Velocidade vs. M√©dia', Math.min(100,Math.round((wpm/wpmBenchmark.avg)*100)), 100, wpm >= wpmBenchmark.avg ? '#00e5a0' : wpm >= wpmBenchmark.low ? '#ffb340' : '#ff4f6b')}
      ${buildScoreBar('Taxa de hesita√ß√£o (inversa)', Math.max(0,100-hesRate*5), 100, hesRate <= 2 ? '#00e5a0' : hesRate <= 8 ? '#ffb340' : '#ff4f6b')}
    </div>

    <div style="margin-top:12px;padding:10px;background:var(--s2);border:1px solid var(--border)">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:2px;margin-bottom:4px">REFER√äNCIA PPM ¬∑ ${wpmBenchmark.label}</div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--t2)">
        Abaixo da m√©dia: &lt;${wpmBenchmark.low} ¬∑ M√©dio: ${wpmBenchmark.avg} ¬∑ Acima: &gt;${wpmBenchmark.high} ¬∑ Seu resultado: <span style="color:var(--t0);font-weight:700">${wpm} PPM</span>
      </div>
    </div>
  </div>

  <div class="report-section">
    <div class="report-sec-title">An√°lise de Erros e Hesita√ß√µes</div>
    ${errorWords.length > 0 ? `
      <div style="margin-bottom:12px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--red);margin-bottom:6px;letter-spacing:1px">ERROS DE LEITURA (${errCount})</div>
        <div class="error-list">${errorWords.map(w=>`<span class="error-tag">${w}</span>`).join('')}</div>
      </div>` : '<div class="report-text-block good">Nenhum erro de leitura registrado.</div>'}
    ${hesWords.length > 0 ? `
      <div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--amb);margin-bottom:6px;letter-spacing:1px">HESITA√á√ïES (${hesCount})</div>
        <div class="error-list">${hesWords.map(w=>`<span class="hesitation-tag">${w}</span>`).join('')}</div>
      </div>` : '<div class="report-text-block good" style="margin-top:8px">Nenhuma hesita√ß√£o registrada.</div>'}
  </div>

  <div class="report-section">
    <div class="report-sec-title">An√°lise Fonol√≥gica Qualitativa</div>
    <div class="phono-grid">
      ${phonoPatterns.map(p => `
        <div class="phono-item">
          <div class="phono-val" style="color:${p.color}">${p.value}</div>
          <div class="phono-name">${p.name}</div>
          <div class="phono-sub">${p.sub}</div>
        </div>
      `).join('')}
    </div>
  </div>

  <div class="report-section">
    <div class="report-sec-title">Impress√£o Cl√≠nica</div>
    ${impressions.map(imp => `<div class="report-text-block ${imp.type}">${imp.text}</div>`).join('')}
  </div>

  ${notes ? `
  <div class="report-section">
    <div class="report-sec-title">Observa√ß√µes do Fonoaudi√≥logo</div>
    <div class="report-text-block">${notes.replace(/\n/g,'<br>')}</div>
  </div>` : ''}

  <div class="report-section">
    <div class="report-sec-title">Recomenda√ß√µes</div>
    ${generateRecommendations(accuracy, wpm, wpmBenchmark, hesRate, errRate, currentLevel).map(r=>`<div class="report-text-block ${r.type}"><strong>${r.title}:</strong> ${r.text}</div>`).join('')}
  </div>

  <div style="text-align:center;margin-top:8px;padding-top:16px;border-top:1px solid var(--border2)">
    <div style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:2px">
      PHONOBASE ¬∑ Protocolo de Avalia√ß√£o de Leitura Oral ¬∑ Sess√£o ${sessionId} ¬∑ ${today}
    </div>
    <button class="print-btn" onclick="window.print()">üñ® Imprimir / Salvar PDF</button>
  </div>
  `;

  document.getElementById('report-body').innerHTML = html;
}

function buildScoreBar(label, value, max, color) {
  const pct = Math.round((value / max) * 100);
  return `
  <div class="score-bar-wrap">
    <div class="score-bar-label">
      <span class="score-bar-name">${label}</span>
      <span class="score-bar-val">${value}${label.includes('%') || label === 'Precis√£o' || label.includes('hesita√ß√£o') ? '%' : ''}</span>
    </div>
    <div class="score-bar">
      <div class="score-bar-fill" style="width:${pct}%;background:${color}"></div>
    </div>
  </div>`;
}

function analyzePhonologicalPatterns(errorWords, hesWords) {
  const allWords = [...errorWords, ...hesWords];
  
  // Analyze patterns
  const fricativas = allWords.filter(w => /[szxfv√ßj]/i.test(w)).length;
  const polisilabicas = allWords.filter(w => w.replace(/[^aeiou√°√©√≠√≥√∫√¢√™√Æ√¥√ª√£√µ]/gi,'').length >= 4).length;
  const clusters = allWords.filter(w => /[bcdfghjklmnpqrstvwxyz]{3}/i.test(w)).length;
  const nasais = allWords.filter(w => /[√£√µmÃÉ]|[mn][^aeiou]/i.test(w)).length;
  
  const total = Math.max(1, allWords.length);
  
  return [
    {name:'Fricativas', sub:'Altera√ß√µes em /s/, /z/, /f/, /v/', value: fricativas > 0 ? fricativas : '0', color: fricativas > 2 ? 'var(--amb)' : 'var(--grn)'},
    {name:'Poliss√≠labas', sub:'Palavras com 4+ s√≠labas', value: polisilabicas > 0 ? polisilabicas : '0', color: polisilabicas > 2 ? 'var(--red)' : 'var(--grn)'},
    {name:'Grupos consonantais', sub:'Encontros consonantais', value: clusters > 0 ? clusters : '0', color: clusters > 1 ? 'var(--amb)' : 'var(--grn)'},
    {name:'Vogais nasais', sub:'/√£/, /√µ/, /mÃÉ/ e variantes', value: nasais > 0 ? nasais : '0', color: nasais > 1 ? 'var(--amb)' : 'var(--grn)'},
    {name:'Comprimento m√©dio', sub:'M√©dia de letras por palavra erro', value: total > 1 ? Math.round(allWords.reduce((a,w)=>a+w.length,0)/total) : '‚Äî', color: 'var(--cyan)'},
    {name:'Taxa de erro', sub:'% palavras com marca√ß√£o', value: errorWords.length + hesWords.length > 0 ? Math.round(((errorWords.length+hesWords.length)/Math.max(1,wordElements.length))*100)+'%' : '0%', color: errorWords.length > 5 ? 'var(--red)' : 'var(--grn)'}
  ];
}

function generateClinicalImpressions(wpm, bench, accuracy, hesRate, errRate, level) {
  const imps = [];
  
  if (accuracy >= 97) {
    imps.push({type:'good', text:`<strong>Precis√£o excelente (${accuracy}%):</strong> A taxa de erros est√° dentro dos par√¢metros esperados para leitura independente. O paciente demonstra representa√ß√µes lexicais consolidadas para o vocabul√°rio avaliado.`});
  } else if (accuracy >= 90) {
    imps.push({type:'', text:`<strong>Precis√£o adequada (${accuracy}%):</strong> Dentro do n√≠vel instrucional. Erros pontuais podem refletir lacunas lexicais espec√≠ficas, processamento fonol√≥gico inconsistente ou demanda cognitiva aumentada pelo n√≠vel do texto.`});
  } else if (accuracy >= 80) {
    imps.push({type:'warn', text:`<strong>Precis√£o lim√≠trofe (${accuracy}%):</strong> Taxa de erro indica dificuldade expressiva. Investigar processamento fonol√≥gico, decodifica√ß√£o grafema-fonema e mem√≥ria de trabalho verbal.`});
  } else {
    imps.push({type:'crit', text:`<strong>Precis√£o cr√≠tica (${accuracy}%):</strong> Dificuldade severa que compromete a funcionalidade leitora. Avalia√ß√£o multidisciplinar recomendada. Considerar hip√≥teses de dislexia, transtorno do processamento fonol√≥gico ou d√©ficit de linguagem.`});
  }

  if (wpm >= bench.high) {
    imps.push({type:'good', text:`<strong>Velocidade de leitura elevada (${wpm} PPM):</strong> Acima da m√©dia para este n√≠vel de dificuldade. Observar se velocidade elevada est√° associada a erros de compreens√£o ou precipita√ß√£o leitora.`});
  } else if (wpm >= bench.avg) {
    imps.push({type:'', text:`<strong>Velocidade adequada (${wpm} PPM):</strong> Taxa de fala leitora compat√≠vel com o n√≠vel de dificuldade e faixa et√°ria/escolar esperada.`});
  } else if (wpm >= bench.low) {
    imps.push({type:'warn', text:`<strong>Velocidade reduzida (${wpm} PPM):</strong> Abaixo da m√©dia esperada. Verificar se a lenta taxa de leitura est√° relacionada a dificuldades de decodifica√ß√£o, comprometimento atencional ou estrat√©gias de autorregula√ß√£o.`});
  } else {
    imps.push({type:'crit', text:`<strong>Velocidade significativamente reduzida (${wpm} PPM):</strong> Muito abaixo da refer√™ncia normativa. Investigar substrato neurol√≥gico, processamento fonol√≥gico e flu√™ncia leitora. Taxa inferior a ${bench.low} PPM no n√≠vel ${LEVEL_NAMES[level]} √© clinicamente relevante.`});
  }

  if (hesRate > 10) {
    imps.push({type:'crit', text:`<strong>Alta taxa de hesita√ß√£o (${hesRate}%):</strong> Hesita√ß√µes frequentes sugerem dificuldade no acesso lexical, inseguran√ßa articulat√≥ria ou processamento serial comprometido. Considerar investiga√ß√£o de gagueira, dispraxia verbal ou disflu√™ncias neurog√™nicas.`});
  } else if (hesRate > 5) {
    imps.push({type:'warn', text:`<strong>Hesita√ß√µes moderadas (${hesRate}%):</strong> Pausas e hesita√ß√µes al√©m do esperado. Avaliar se h√° padr√£o de palavras ou estruturas sint√°ticas espec√≠ficas associadas √†s pausas.`});
  }

  return imps;
}

function generateRecommendations(accuracy, wpm, bench, hesRate, errRate, level) {
  const recs = [];

  if (accuracy >= 97 && wpm >= bench.avg && hesRate <= 2) {
    recs.push({type:'good', title:'Progress√£o de n√≠vel', text:`Desempenho compat√≠vel com avan√ßo para o n√≠vel ${Math.min(6,level+1)} (${LEVEL_NAMES[Math.min(6,level+1)]}). Manter registro longitudinal.`});
  }
  if (accuracy < 90) {
    recs.push({type:'warn', title:'Interven√ß√£o em decodifica√ß√£o', text:'Investigar correspond√™ncia grafema-fonema. Aplicar protocolos de consci√™ncia fonol√≥gica e awareness fon√™mico. Avaliar necessidade de encaminhamento neuropsicol√≥gico.'});
  }
  if (wpm < bench.low) {
    recs.push({type:'crit', title:'Flu√™ncia leitora', text:'Implementar protocolo de leitura repetida (Repeated Reading). Monitorar PPM semanalmente. Avaliar processamento fonol√≥gico de baixo n√≠vel (segmenta√ß√£o, identifica√ß√£o fon√™mica).'});
  }
  if (hesRate > 8) {
    recs.push({type:'warn', title:'Avalia√ß√£o de flu√™ncia', text:'Alta taxa de hesita√ß√£o requer avalia√ß√£o espec√≠fica de flu√™ncia oral. Considerar protocolos para disflu√™ncias: SSI-4, protocolo de Iowa, an√°lise de disflu√™ncias t√≠picas vs. at√≠picas.'});
  }
  recs.push({type:'', title:'Pr√≥xima sess√£o', text:`Reavaliar em ${accuracy < 90 ? '1' : '2'} semana(s). Aplicar texto alternativo do mesmo n√≠vel para controle de vari√°veis. Registrar qualidade vocal, respira√ß√£o e postura durante leitura.`});

  return recs;
}

/* ‚ïê‚ïê MARK MODE INIT ‚ïê‚ïê */
setMarkMode('error');
</script>
</body>
</html>
